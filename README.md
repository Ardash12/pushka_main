# pushka_main

## Инструкция по локальному развертыванию бэкэнда

#### 1. Cклонировать данный репозиторий

```
git clone https://github.com/WebByte/pushka_main.git
``` 
#### 2. Перейти в папку проекта в консоли

```
cd pushka_main
```

#### 3. Создать виртуальное окружение и активировать его (вводим команды в командной строке из папки проекта)

```
* python -m venv venv
* venv/Scripts/activate.bat
```
ВАЖНО, если не был ранее установлен python на устройстве, его надо установить

#### 4. Устанавливаем зависимости проекта (вводим команду в командной строке из папки проекта)

```
pip install -r requirements.txt

```

#### 5. Проверяем, установлен ли postgresDb. Если нет, то устанавливаем. Заходим в pgadmin, логинимся и создаем БД - pushka_test

#### 6. Запускаем в Docker образ tarantool db. Предварительно, устанавливаем докер, если он не установлен. Команда для запуска контейнера тарантула: 

```
docker run --name tarantool -p 3301:3301 -it tarantool/tarantool:2.8

```

#### 7. Открываем файл .env в папке проекта и добавляем актуальные для вас значение в переменной POSTGRES_PASSWORD_TEST

```

POSTGRES_DB_TEST='pushka_test'
POSTGRES_NAME_TEST="postgres"
POSTGRES_HOST_TEST="localhost"
POSTGRES_PASSWORD_TEST="enterPasswordd"
POSTGRES_PORT_TEST=5312
TARANTOOL_HOST_TEST='localhost'
TARANTOOL_PORT_TEST=3301
```

#### 8. Создать файл миграции командой 
```
alembic revision --autogenerate -m "Init tables"
```

#### 9. Выполнить миграцию таблиц в БД командой
```
alembic upgrade head
```

#### 10. Запустить проект
```
uvicorn main:app --reload
```

#### 11. При первом запуске начнется загрузка данных в БД Postgress(технические таблицы, загружаются быстро, минут 5-10) и tarantool (загрузка рекомендаций, загружаются долго). Полная загрузка занимает около 10 часов. Для теста, наверное, будет достаточно, чтобы загрузилось рекомендаций хотя бы для 50 айдишек пользователей по кажжому типу рекомендаций.
Лайфхак для этого. После выполнения 10 пункта в консоли появятся логи сервера. Как только появится в логах надпись "Load recommendations data from {тип рекомендации} to tarantool" и начнется загрузка рекомендаций этого типа (в логах будет писаться, что 'added recs for {current_count} of {count_of_user} users '), подожать секунд 10-15 и отключить сервер, нажав Ctrl+C. Затем, заново его запустить (пункт 10). И так надо будет сделать 4 раза, чтобы по каждому типу загрузилось штук 50-100 рекомендаций.

С этого момента можно использовать API для локальной работы

Всего в базе есть 4 типа рекомендаций: 
1. regional_rec (региональные рекомендации от команды Стаса)
2. 3day_recs_from_filtered_events (рекомендации от команды Наили)
3. 3day_recs_from_filtered_top (рекомендации от команды Наили)
4. user_rec_without_filter (рекомендации от команды Наили)


При локальной работе хост будет таким http://127.0.0.1:8000

Адреса АПИ:
1. Получение рекомендаций типа regional_rec
  GET запрос
  ```
  http://127.0.0.1:8000/api/v1/recommendations_by_id?id=%id&type=%type
  ```
  На вход принимает query параметры:
      id(строка) - айди пользователя (в рекомендациях было в таком формате, для примера, 005bbb70559ac82250d8099760f7df50)
      type(строка) - тип рекомендаций (указываем regional_rec)
      
  То есть для данного примера полный путь для получения данных рекомендаций будет (для локального использования): 
      http://127.0.0.1:8000/api/v1/recommendations_by_id?id=005bbb70559ac82250d8099760f7df50&type=regional_rec
      
2. Получение рекомендаций остальных типов (от команды Наили):
    GET запрос
  ```
  http://127.0.0.1:8000/api/v1/recommendations_by_phone?phone=%phone&type=%type
  ```
  На вход принимает query параметры:
      phone(строка) - я так понимаю, что это закодированный телефон пользователя, в таком виде было указано в модели от команда ДС (в рекомендациях было в таком формате, для примера, 6a4816fe848efbd8c8fb8e8760d7cbd1)
      type(строка) - тип рекомендаций (указываем 3day_recs_from_filtered_events или 3day_recs_from_filtered_top или user_rec_without_filter, в зависимости от того, какой тип рекомендации собираемся использовать)
      
 Примеры для теста для каждого типа рекомендаций: 
     3day_recs_from_filtered_events - http://127.0.0.1:8000/api/v1/recommendations_by_phone?phone=6a4816fe848efbd8c8fb8e8760d7cbd1&type=3day_recs_from_filtered_events
     3day_recs_from_filtered_top - http://127.0.0.1:8000/api/v1/recommendations_by_phone?phone=6a4816fe848efbd8c8fb8e8760d7cbd1&type=3day_recs_from_filtered_top
     user_rec_without_filter - http://127.0.0.1:8000/api/v1/recommendations_by_phone?phone=6a4816fe848efbd8c8fb8e8760d7cbd1&type=user_rec_without_filter
     
Ответ сервера на каждый из этих двух эндпойнтов - список рекомендаций. В случае, если рекомендация по заявленным на вход данным не найдена, будет в ответе будет ошибка - status_code=400, detail="Bad request. Recommendations were not found". В таком случае данному человеку нечего показывать. 


2. API статистики кликов по рекомендациям: 
      POST запрос - необходимо вставить отправку запроса при клике по рекомендации
      ```
      http://127.0.0.1:8000/click_stat
      ```
      
      В теле запроса нужно будет передать параметры в таком формате:
      {
        "user_id": "string", #####айди пользователя
        "event_id": 'integer', #####айди мероприятия
        "event_type": "string", #####тип рекомендации
      }
      
      GET запрос - это больше технический запрос, вряд ли он на фронте понадобится. 
      ```
      http://127.0.0.1:8000/click_stat
      ```

###Документация API локально находится по адресу ниже. Тут можно посмотреть все данные на вход и то, что получается в ответ по каждому URL
      ```
      http://127.0.0.1:8000/docs
      ```
      
      
      
